<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>使用 Fluentd 協助整理 log | ocowchun</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/app.css">
  <!-- <link rel='stylesheet' href='http://fonts.useso.com/css?family=Source+Code+Pro'> -->
</head>

<body>
  <nav class="app-nav">
  
      
        <a class="active" href="/.">home</a>
        

      
  
      
        <a href="/archives">archive</a>
      
  
      
        <a href="/about">about</a>
      
  
      
        <a href="/atom.xml">rss</a>
      
  
</nav>

  <main class="post">
  <article>
  <h1 class="article-title">
    <a href="/2016/05/14/use-fluent-to-handle-log/">使用 Fluentd 協助整理 log</a>
  </h1>

  <section class="article-meta">
    <p class="article-date">五月 14 2016</p>
  </section>

  <section class="article-entry">
    <h2 id="Quick-Install"><a href="#Quick-Install" class="headerlink" title="Quick Install"></a>Quick Install</h2><h3 id="before-install"><a href="#before-install" class="headerlink" title="before-install"></a>before-install</h3><h4 id="Increase-Max-of-File-Descriptors"><a href="#Increase-Max-of-File-Descriptors" class="headerlink" title="Increase Max # of File Descriptors"></a>Increase Max # of File Descriptors</h4><p>Please increase the maximum number of file descriptors. You can check the current number using the ulimit -n command.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">ulimit</span> -n</div></pre></td></tr></table></figure>
<p>If your console shows 1024, it is insufficient. Please add following lines to your /etc/security/limits.conf file and reboot your machine.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">root soft nofile 65536</div><div class="line">root hard nofile 65536</div><div class="line">* soft nofile 65536</div><div class="line">* hard nofile 65536</div></pre></td></tr></table></figure>
<h3 id="Step-1-Install-from-Apt-Repository"><a href="#Step-1-Install-from-Apt-Repository" class="headerlink" title="Step 1 : Install from Apt Repository"></a>Step 1 : Install from Apt Repository</h3><p>For Ubuntu, “Ubuntu 14.04 LTS / Trusty”, “Ubuntu 12.04 LTS / Precise” and “Ubuntu 10.04 LTS / Lucid” are currently supported.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -L http://toolbelt.treasuredata.com/sh/install-ubuntu-trusty-td-agent2.sh | sh</div></pre></td></tr></table></figure>
<h3 id="Step2-Launch-Daemon"><a href="#Step2-Launch-Daemon" class="headerlink" title="Step2: Launch Daemon"></a>Step2: Launch Daemon</h3><p>The /etc/init.d/td-agent script is provided to start, stop, or restart the agent.<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ sudo /etc/init.d/td-agent restart</div><div class="line">$ sudo /etc/init.d/td-agent status</div><div class="line">td-agent (pid  21678) is running..</div></pre></td></tr></table></figure></p>
<p>Please make sure your configuration file is located at /etc/td-agent/td-agent.conf.</p>
<h3 id="Step3-Post-Sample-Logs-via-HTTP"><a href="#Step3-Post-Sample-Logs-via-HTTP" class="headerlink" title="Step3: Post Sample Logs via HTTP"></a>Step3: Post Sample Logs via HTTP</h3><p>By default, /etc/td-agent/td-agent.conf is configured to take logs from HTTP and route them to stdout (/var/log/td-agent/td-agent.log). You can post sample log records using the curl command.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ curl -X POST <span class="_">-d</span> <span class="string">'json=&#123;"json":"message"&#125;'</span> http://localhost:8888/debug.test</div></pre></td></tr></table></figure>
<h2 id="Config-Introduction"><a href="#Config-Introduction" class="headerlink" title="Config Introduction"></a><a href="http://docs.fluentd.org/articles/config-file" target="_blank" rel="external">Config Introduction</a></h2><ol>
<li><strong>source</strong> directives determine the input sources.</li>
<li><strong>match</strong> directives determine the output destinations.</li>
<li><strong>include</strong> directives include other files.</li>
<li><strong>system</strong> directives set system wide configuration.</li>
</ol>
<h3 id="source-where-all-the-data-come-from"><a href="#source-where-all-the-data-come-from" class="headerlink" title="source:where all the data come from"></a>source:where all the data come from</h3><p>設定要輸入的log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;source&gt;</div><div class="line">  type forward</div><div class="line">  port 24224</div><div class="line">&lt;/source&gt;</div></pre></td></tr></table></figure></p>
<p>source directive一定要包含<code>type</code>參數,<code>type</code>會決定要使用哪個input plugin</p>
<h3 id="match-Tell-fluentd-what-to-do"><a href="#match-Tell-fluentd-what-to-do" class="headerlink" title="match:Tell fluentd what to do!"></a>match:Tell fluentd what to do!</h3><p>通常用於將event輸出到其他系統(eg:file,hdfs,s3…etc)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;match myapp.access&gt;</div><div class="line">  type file</div><div class="line">  path /var/log/fluent/access</div><div class="line">&lt;/match&gt;</div></pre></td></tr></table></figure></p>
<p>match directive一定要包含match pattern與<code>type</code>參數<br><code>match pattern</code>決定有些資料需要輸出,<code>type</code>會決定要使用哪個output plugin</p>
<h4 id="match-pattern"><a href="#match-pattern" class="headerlink" title="match pattern"></a><a href="http://docs.fluentd.org/articles/config-file#match-pattern-how-you-control-the-event-flow-inside-fluentd" target="_blank" rel="external">match pattern</a></h4><h2 id="tail-log-101"><a href="#tail-log-101" class="headerlink" title="tail log 101"></a>tail log 101</h2><h3 id="tail-Rails-log"><a href="#tail-Rails-log" class="headerlink" title="tail Rails log"></a>tail Rails log</h3><h4 id="1-add-below-to-Gemfile"><a href="#1-add-below-to-Gemfile" class="headerlink" title="1. add below to Gemfile"></a>1. add below to <code>Gemfile</code></h4><figure class="highlight rb"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">gem <span class="string">'lograge'</span></div><div class="line">gem <span class="string">"logstash-event"</span></div></pre></td></tr></table></figure>
<h4 id="2-add-below-to-config-application-rb"><a href="#2-add-below-to-config-application-rb" class="headerlink" title="2. add below to config/application.rb"></a>2. add below to <code>config/application.rb</code></h4><figure class="highlight rb"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">config.lograge.enabled = <span class="literal">true</span></div><div class="line">config.lograge.formatter = Lograge::Formatters::Logstash.new</div></pre></td></tr></table></figure>
<h4 id="3-comment-config-environments-production-rb-log-formatter"><a href="#3-comment-config-environments-production-rb-log-formatter" class="headerlink" title="3. comment config/environments/production.rb log_formatter"></a>3. comment <code>config/environments/production.rb</code> log_formatter</h4><figure class="highlight rb"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># config.log_formatter = ::Logger::Formatter.new</span></div></pre></td></tr></table></figure>
<h4 id="4-add-lograge-to-Gemfile"><a href="#4-add-lograge-to-Gemfile" class="headerlink" title="4. add lograge to Gemfile"></a>4. add <code>lograge</code> to <code>Gemfile</code></h4><figure class="highlight rb"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">gem <span class="string">'lograge'</span></div><div class="line"><span class="string">``</span><span class="string">` </span></div><div class="line"></div><div class="line">#### 5. add this line to `config/environments/production.rb<span class="string">`</span></div><div class="line">`<span class="string">``</span>rb</div><div class="line">    config.lograge.formatter = Lograge::Formatters::Logstash.new</div></pre></td></tr></table></figure>
<h4 id="6-add-below-to-td-agent-conf"><a href="#6-add-below-to-td-agent-conf" class="headerlink" title="6. add below to td-agent.conf"></a>6. add below to <code>td-agent.conf</code></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;source&gt;</div><div class="line">  type tail</div><div class="line">  path /home/vagrant/apps/your-rails-app/shared/log/production.log</div><div class="line">  tag debug.test</div><div class="line">  format json</div><div class="line">&lt;/source&gt;</div></pre></td></tr></table></figure>
<h3 id="tail-nginx-log"><a href="#tail-nginx-log" class="headerlink" title="tail nginx log"></a>tail nginx log</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;source&gt;</div><div class="line">  type tail</div><div class="line">  path /var/log/nginx/access.log</div><div class="line">  tag debug.test</div><div class="line">  format nginx</div><div class="line">&lt;/source&gt;</div></pre></td></tr></table></figure>
<h2 id="integrate-fluent-with-kibana"><a href="#integrate-fluent-with-kibana" class="headerlink" title="integrate fluent with kibana"></a>integrate fluent with kibana</h2><h3 id="1-install-kibana"><a href="#1-install-kibana" class="headerlink" title="1. install kibana"></a>1. install kibana</h3><h4 id="1-1-download-and-extract-kibana"><a href="#1-1-download-and-extract-kibana" class="headerlink" title="1.1 download and extract kibana"></a>1.1 download and extract kibana</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ curl -O http://download.elastic.co/kibana/kibana/kibana-4.1.0-snapshot-linux-x64.tar.gz</div><div class="line">$ tar cvf kibana-4.1.0-snapshot-linux-x64.tar.gz</div></pre></td></tr></table></figure>
<h4 id="1-2-install-pm2"><a href="#1-2-install-pm2" class="headerlink" title="1.2 install pm2"></a>1.2 install pm2</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo npm install -g pm2</div></pre></td></tr></table></figure>
<h4 id="1-3-edit-config-kibana-yml-in-kibana-4-1-0-snapshot-linux-x64"><a href="#1-3-edit-config-kibana-yml-in-kibana-4-1-0-snapshot-linux-x64" class="headerlink" title="1.3 edit config/kibana.yml in kibana-4.1.0-snapshot-linux-x64"></a>1.3 edit <code>config/kibana.yml</code> in <code>kibana-4.1.0-snapshot-linux-x64</code></h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">elasticsearch_url:</span> <span class="string">"http://your-elasticsearch-url:9200"</span></div></pre></td></tr></table></figure>
<h4 id="1-4-add-kibana-process-json-to-kibana-folder"><a href="#1-4-add-kibana-process-json-to-kibana-folder" class="headerlink" title="1.4 add kibana-process.json to kibana folder"></a>1.4 add <code>kibana-process.json</code> to kibana folder</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"script"</span>: <span class="string">"./src/bin/kibana.js"</span>,</div><div class="line">  <span class="string">"max_memory_restart"</span>: <span class="string">"100M"</span>,</div><div class="line">  <span class="string">"env"</span>: &#123;</div><div class="line">    <span class="string">"NODE_ENV"</span>: <span class="string">"production"</span>,</div><div class="line">    <span class="string">"CONFIG_PATH"</span>: <span class="string">"./config/kibana.yml"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="1-5-start-kibana"><a href="#1-5-start-kibana" class="headerlink" title="1.5 start kibana"></a>1.5 start kibana</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ pm2 start kibana-process.json</div></pre></td></tr></table></figure>
<h3 id="2-setting-elasticsearch"><a href="#2-setting-elasticsearch" class="headerlink" title="2. setting elasticsearch"></a>2. setting elasticsearch</h3><p>修改<code>elasticsearch.yml</code>,設定<code>http.cors.enabled</code>為true<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http.cors.enabled: <span class="literal">true</span></div></pre></td></tr></table></figure></p>
<h3 id="3-install-Elasticsearch-plugin-for-td-agent"><a href="#3-install-Elasticsearch-plugin-for-td-agent" class="headerlink" title="3. install  Elasticsearch plugin for td-agent"></a>3. install  Elasticsearch plugin for td-agent</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install libcurl4-openssl-dev</div><div class="line">sudo /usr/sbin/td-agent-gem install fluent-plugin-elasticsearch</div></pre></td></tr></table></figure>
<h3 id="4-edittd-agent-conf-send-nginx-log-to-elastic-search"><a href="#4-edittd-agent-conf-send-nginx-log-to-elastic-search" class="headerlink" title="4. edittd-agent.conf,send nginx log to elastic search"></a>4. edit<code>td-agent.conf</code>,send nginx log to elastic search</h3><p><a href="http://docs.fluentd.org/recipe/nginx/elasticsearch" target="_blank" rel="external">link</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;source&gt;</div><div class="line">  type tail</div><div class="line">  path /var/log/httpd-access.log #...or where you placed your Apache access log</div><div class="line">  pos_file /var/log/td-agent/httpd-access.log.pos # This is where you record file position</div><div class="line">  tag nginx.access #fluentd tag!</div><div class="line">  format nginx # Do you have a custom format? You can write your own regex.</div><div class="line">&lt;/source&gt;</div><div class="line"></div><div class="line">&lt;match **&gt;</div><div class="line">  type elasticsearch</div><div class="line">  logstash_format true</div><div class="line">  host &lt;hostname&gt; #(optional; default=&quot;localhost&quot;)</div><div class="line">  port &lt;port&gt; #(optional; default=9200)</div><div class="line">  index_name &lt;index name&gt; #(optional; default=fluentd)</div><div class="line">  type_name &lt;type name&gt; #(optional; default=fluentd)</div><div class="line">&lt;/match&gt;</div></pre></td></tr></table></figure></p>
<p>這樣就可以使用kibana來檢視log</p>
<p><a href="http://docs.fluentd.org/articles/before-install" target="_blank" rel="external">before-install</a><br><a href="http://docs.fluentd.org/articles/config-file" target="_blank" rel="external">config-file</a><br><a href="http://docs.fluentd.org/articles/config-file#match-pattern-how-you-control-the-event-flow-inside-fluentd" target="_blank" rel="external">match pattern</a></p>

  </section>
</article>

  <div class="sharing grid">
  <section class="profile grid-item grid">
    <img class="avatar" src="https://www.gravatar.com/avatar/a7da45a4a1667717721e9a81d66845ff" alt="avatar" />
    <div class="grid-item">
      <p class="title"> ocowchun </p>
      <p class="subtitle"> yoyoyo </p>
    <div>
  </section>

  <section class="share-btns">
    <!-- <p> share it if you like it~ </p> -->
    <a
  class="twitter-share-button"
  data-size="large"
  data-via="ocowchun"
  href="https://twitter.com/intent/tweet?text= id="Quick-Install">"
>
  Tweet
</a>

<script>
  window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  js.async = true;
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));
</script>

  </section>
</div>


  
    
<section class="article-comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

<script>
  var disqus_shortname = 'ocowchun';
  
  var disqus_url = 'https://blog.ocowchun.com/2016/05/14/use-fluent-to-handle-log/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  
</main>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-78480228-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
